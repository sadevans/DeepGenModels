# Домашнее задание №1
## **Задача 1**: Байесовский генератор стилей
Код для данного домашнего задания находится в папке `hw1_task1/` в ноутбуке `task1.ipynb`.
### Генератор на основе данных о популярных стилях
1. Принцип работы генератора

Класс SimpleStyleGenerator создает случайные аватары, используя статистику существующих стилей. Он анализирует, какие варианты внешности встречаются чаще, и генерирует новые аватары на основе этих статистик. 

2. Инициализация генератора

При создании генератора загружаются данные о стилях из файла styles.py:

- `styles` - словарь с категориями (цвет волос, прическа и др.) и возможными вариантами

- `styles_count` - сколько раз каждый вариант встречался в исходных данных

- `total_counts` - общее количество наблюдений по каждой категории

3. Процесс генерации аватара

Для каждой категории генератор:

- Вычисляет вероятности всех вариантов методом MLE, используя частоты из данных

- Случайно выбирает вариант согласно этим вероятностям

- Записывает выбор и вычисляет его вероятность

4. Расчет общей вероятности

Общая вероятность аватара рассчитывается как произведение вероятностей всех отдельных выборов. Для устойчивости вычислений используется логарифмическая вероятность: cначала суммируются логарифмы вероятностей, а затем результат преобразуется обратно через экспоненту

#### Выходные данные
Для примера генератор вернул:
```
Сгенерированный стиль:
  прическа: нет волос
  цвет волос: рыжий
  аксесуар: солнцезащитные очки
  одежда: футболка с круглым вырезом
  цвет одежды: розовый
Вероятность генерации: 0.000463

Сгенерированный стиль:
  прическа: короткая прямые
  цвет волос: рыжий
  аксесуар: нет очков
  одежда: худи
  цвет одежды: красный
Вероятность генерации: 0.000152

Сгенерированный стиль:
  прическа: короткая прямые
  цвет волос: черный
  аксесуар: круглые очки
  одежда: футболка с круглым вырезом
  цвет одежды: белый
Вероятность генерации: 0.000618

Сгенерированный стиль:
  прическа: короткая прямые
  цвет волос: блонд
  аксесуар: нет очков
  одежда: футболка с круглым вырезом
  цвет одежды: серый
Вероятность генерации: 0.000265

Сгенерированный стиль:
  прическа: длинные прямые
  цвет волос: черный
  аксесуар: круглые очки
  одежда: футболка с круглым вырезом
  цвет одежды: синий
Вероятность генерации: 0.001077
```

### Генератор аватаров на основе пиксельных распределений
(В нем, мне кажется, что-то не так)
1. Основная концепция

Генератор создает новые изображения, анализируя статистику пикселей из набора существующих аватаров.

2. Этап инициализации

При создании объекта генератора:

- Указывается папка с исходными изображениями (folder)

- Сразу вызывается метод _compute_pixel_distributions(), который анализирует все изображения

3. Анализ исходных изображений

Метод _compute_pixel_distributions() выполняет ключевую работу:

Он рекурсивно проходит по всем файлам в указанной папке, фильтрует только PNG/JPG/JPEG изображения, конвертирует их в RGB-формат и преобразует в numpy-массивы. Объединяет все изображения в один трехмерный массив (число_изображений × высота × ширина × 3_канала). Для каждого пикселя (x,y) и каждого цветового канала (R,G,B):

- Считает частоту встречаемости каждого значения (0-255)

- Применяет сглаживание Лапласа (добавляет 1 к каждому счетчику), чтобы избежать нулевых вероятностей

- Нормализует распределение

- Сохраняет только ненулевые вероятности для экономии памяти

4. Генерация нового аватара

Метод generate() создает новое изображение: создает пустой массив (черное изображение) размером как исходные аватары. Для каждого пикселя и канала:
- Получает сохраненное распределение вероятностей

- Нормализует вероятности

- Случайно выбирает значение пикселя согласно распределению

- Обновляет суммарную логарифмическую вероятность
#### Выходные данные
Можно посмотреть в папке `hw1_task1`.

## **Задача 2**: Детекция аномалий

### Выбранная архитектура

Для решения задачи детекции аномалий выбрала MNAD. Реализацию архитектуры взяла [тут](https://github.com/cvlab-yonsei/MNAD/tree/master)

В конфиге для инцициализации модели заданы следующие параметры:
```
model:
  _target_: model.mnad.MNAD
  t_length: 2
  memory_size: 10 
  feature_dim: 512
  key_dim: 512
  temp_update: 0.1
  temp_gather: 0.1  
```
Здесь:
- `t_length` - длина временного окна (количество последовательных кадров) для обработки.
- `memory_size` -  количество "слотов" в памяти модели.
- `feature_dim` - размерность feature-векторов, извлекаемых из входных данных.
- `key_dim` -  размерность ключей, используемых для адресации памяти.
- `temp_update` - параметр "мягкости" обновления памяти.
- `temp_gather` - параметр "мягкости" при выборке из памяти.


### Обучение автоэнкодера

Чтобы запустить обучение автоэнкодера, необходимо в директорию `./hw1/configs/` положить конфиг, в котором будут заданы все параметры обучения. Пример такого конфига можно посмотреть тут.

После того, как создадите конфиг, можно запускать обучение:
```bash
bash scripts/train.sh
```

### Лучший эксперимент

Пока что зашел следующий сетап для обучения:
```
model:
  _target_: model.mnad.MNAD
  t_length: 2
  memory_size: 20 
  feature_dim: 512
  key_dim: 512
  temp_update: 0.1
  temp_gather: 0.1   

train:
  optimizer:
    _target_: torch.optim.Adam
    lr:  2e-4
    weight_decay: 1e-5
  lr_schedule:
      name: 'cosine'
  n_epoch: 60
  freq_vis: 50
  activation: 'None'
  loss_compact: 0.01
  loss_separate: 0.01
```

### Итоговый порог для лучшего эксперимента и метрики

Порог автоматически считается для соответствующего эксперимента при запуске следующей команды:
```bash
bash scripts/run_inference.sh
```
Тут же происходит и тестирование и подсчет метрик.

На данный момент лучший порог по MSE - `0.0003`. Для него вот такие графики.

<img src="./figs/threshold_analysis.png" alt="" width="900" height="400">

С ним получаются вот такие метрики:

|Метрика|Значение|
|---|---|
|True Positive Rate (TPR)|0.9922|
|True Negative Rate (TNR)|0.7836|
|Accuracy|0.7907|
|ROC AUC|0.9897|

Кривая ROC выглядит вот так:

<img src="./figs/test_roc_curve.png" alt="" width="400" height="400">


Пример тестовых изображений и реконстурированных:

<img src="./figs/original_test_batch.png" alt="" width="400" height="400">
<img src="./figs/rec_test_batch.png" alt="" width="400" height="400">